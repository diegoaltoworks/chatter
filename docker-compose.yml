version: "3.8"

services:
  chatter:
    build: .
    ports:
      - "8181:8181"
    environment:
      # OpenAI Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Database Configuration (Turso)
      - TURSO_URL=${TURSO_URL}
      - TURSO_AUTH_TOKEN=${TURSO_AUTH_TOKEN}

      # Bot Configuration
      - BOT_NAME=${BOT_NAME:-Chatter}
      - BOT_PERSON_NAME=${BOT_PERSON_NAME:-Admin}
      - BOT_PUBLIC_URL=${BOT_PUBLIC_URL:-http://localhost:8181}
      - BOT_DESCRIPTION=${BOT_DESCRIPTION:-AI chatbot powered by Chatter}

      # Authentication (optional)
      - CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - JWT_SECRET=${JWT_SECRET}

      # Security
      - CHATTER_SECRET=${CHATTER_SECRET}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}

      # Rate Limiting
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60000}

    volumes:
      # Mount knowledge base directory
      - ./knowledge:/app/knowledge:ro
      # Mount prompts directory
      - ./prompts:/app/prompts:ro

    healthcheck:
      test: ["CMD", "bun", "--eval", "fetch('http://localhost:8181/healthz').then(r => r.ok ? process.exit(0) : process.exit(1))"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

    restart: unless-stopped

  # Example: Run with local Turso database
  # Uncomment if you want to run Turso locally instead of using cloud
  # turso:
  #   image: ghcr.io/tursodatabase/libsql-server:latest
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - SQLD_NODE=primary
  #   volumes:
  #     - turso-data:/var/lib/sqld
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 3

# volumes:
#   turso-data:
